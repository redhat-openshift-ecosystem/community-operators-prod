apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  creationTimestamp: null
  name: operatorconfigs.automotive.sdv.cloud.redhat.com
spec:
  group: automotive.sdv.cloud.redhat.com
  names:
    kind: OperatorConfig
    listKind: OperatorConfigList
    plural: operatorconfigs
    singular: operatorconfig
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.osBuilds.enabled
      name: OS Builds
      type: boolean
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: OperatorConfig is the Schema for the operatorconfigs API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: OperatorConfigSpec defines the desired state of OperatorConfig
            properties:
              buildAPI:
                description: BuildAPI defines configuration for the Build API server
                properties:
                  authentication:
                    description: Authentication configuration for the Build API server.
                    properties:
                      clientId:
                        description: OIDC client ID for caib CLI.
                        type: string
                      internal:
                        description: Internal authentication configuration.
                        properties:
                          prefix:
                            default: 'internal:'
                            description: Prefix to add to the subject claim of issued
                              tokens.
                            type: string
                        type: object
                      jwt:
                        description: JWT authentication configuration for OIDC providers.
                        items:
                          description: JWTAuthenticator provides the configuration
                            for a single JWT authenticator.
                          properties:
                            claimMappings:
                              description: claimMappings points claims of a token
                                to be treated as user attributes.
                              properties:
                                extra:
                                  description: |-
                                    extra represents an option for the extra attribute.
                                    expression must produce a string or string array value.
                                    If the value is empty, the extra mapping will not be present.

                                    hard-coded extra key/value
                                    - key: "foo"
                                      valueExpression: "'bar'"
                                    This will result in an extra attribute - foo: ["bar"]

                                    hard-coded key, value copying claim value
                                    - key: "foo"
                                      valueExpression: "claims.some_claim"
                                    This will result in an extra attribute - foo: [value of some_claim]

                                    hard-coded key, value derived from claim value
                                    - key: "admin"
                                      valueExpression: '(has(claims.is_admin) && claims.is_admin) ? "true":""'
                                    This will result in:
                                     - if is_admin claim is present and true, extra attribute - admin: ["true"]
                                     - if is_admin claim is present and false or is_admin claim is not present, no extra attribute will be added
                                  items:
                                    description: ExtraMapping provides the configuration
                                      for a single extra mapping.
                                    properties:
                                      key:
                                        description: |-
                                          key is a string to use as the extra attribute key.
                                          key must be a domain-prefix path (e.g. example.org/foo). All characters before the first "/" must be a valid
                                          subdomain as defined by RFC 1123. All characters trailing the first "/" must
                                          be valid HTTP Path characters as defined by RFC 3986.
                                          key must be lowercase.
                                          Required to be unique.
                                        type: string
                                      valueExpression:
                                        description: |-
                                          valueExpression is a CEL expression to extract extra attribute value.
                                          valueExpression must produce a string or string array value.
                                          "", [], and null values are treated as the extra mapping not being present.
                                          Empty string values contained within a string array are filtered out.

                                          CEL expressions have access to the contents of the token claims, organized into CEL variable:
                                          - 'claims' is a map of claim names to claim values.
                                            For example, a variable named 'sub' can be accessed as 'claims.sub'.
                                            Nested claims can be accessed using dot notation, e.g. 'claims.foo.bar'.

                                          Documentation on CEL: https://kubernetes.io/docs/reference/using-api/cel/
                                        type: string
                                    required:
                                    - key
                                    - valueExpression
                                    type: object
                                  type: array
                                groups:
                                  description: |-
                                    groups represents an option for the groups attribute.
                                    The claim's value must be a string or string array claim.
                                    If groups.claim is set, the prefix must be specified (and can be the empty string).
                                    If groups.expression is set, the expression must produce a string or string array value.
                                     "", [], and null values are treated as the group mapping not being present.
                                  properties:
                                    claim:
                                      description: |-
                                        claim is the JWT claim to use.
                                        Mutually exclusive with expression.
                                      type: string
                                    expression:
                                      description: |-
                                        expression represents the expression which will be evaluated by CEL.

                                        CEL expressions have access to the contents of the token claims, organized into CEL variable:
                                        - 'claims' is a map of claim names to claim values.
                                          For example, a variable named 'sub' can be accessed as 'claims.sub'.
                                          Nested claims can be accessed using dot notation, e.g. 'claims.foo.bar'.

                                        Documentation on CEL: https://kubernetes.io/docs/reference/using-api/cel/

                                        Mutually exclusive with claim and prefix.
                                      type: string
                                    prefix:
                                      description: |-
                                        prefix is prepended to claim's value to prevent clashes with existing names.
                                        prefix needs to be set if claim is set and can be the empty string.
                                        Mutually exclusive with expression.
                                      type: string
                                  type: object
                                uid:
                                  description: |-
                                    uid represents an option for the uid attribute.
                                    Claim must be a singular string claim.
                                    If uid.expression is set, the expression must produce a string value.
                                  properties:
                                    claim:
                                      description: |-
                                        claim is the JWT claim to use.
                                        Either claim or expression must be set.
                                        Mutually exclusive with expression.
                                      type: string
                                    expression:
                                      description: |-
                                        expression represents the expression which will be evaluated by CEL.

                                        CEL expressions have access to the contents of the token claims, organized into CEL variable:
                                        - 'claims' is a map of claim names to claim values.
                                          For example, a variable named 'sub' can be accessed as 'claims.sub'.
                                          Nested claims can be accessed using dot notation, e.g. 'claims.foo.bar'.

                                        Documentation on CEL: https://kubernetes.io/docs/reference/using-api/cel/

                                        Mutually exclusive with claim.
                                      type: string
                                  type: object
                                username:
                                  description: |-
                                    username represents an option for the username attribute.
                                    The claim's value must be a singular string.
                                    Same as the --oidc-username-claim and --oidc-username-prefix flags.
                                    If username.expression is set, the expression must produce a string value.
                                    If username.expression uses 'claims.email', then 'claims.email_verified' must be used in
                                    username.expression or extra[*].valueExpression or claimValidationRules[*].expression.
                                    An example claim validation rule expression that matches the validation automatically
                                    applied when username.claim is set to 'email' is 'claims.?email_verified.orValue(true) == true'. By explicitly comparing
                                    the value to true, we let type-checking see the result will be a boolean, and to make sure a non-boolean email_verified
                                    claim will be caught at runtime.

                                    In the flag based approach, the --oidc-username-claim and --oidc-username-prefix are optional. If --oidc-username-claim is not set,
                                    the default value is "sub". For the authentication config, there is no defaulting for claim or prefix. The claim and prefix must be set explicitly.
                                    For claim, if --oidc-username-claim was not set with legacy flag approach, configure username.claim="sub" in the authentication config.
                                    For prefix:
                                        (1) --oidc-username-prefix="-", no prefix was added to the username. For the same behavior using authentication config,
                                            set username.prefix=""
                                        (2) --oidc-username-prefix="" and  --oidc-username-claim != "email", prefix was "<value of --oidc-issuer-url>#". For the same
                                            behavior using authentication config, set username.prefix="<value of issuer.url>#"
                                        (3) --oidc-username-prefix="<value>". For the same behavior using authentication config, set username.prefix="<value>"
                                  properties:
                                    claim:
                                      description: |-
                                        claim is the JWT claim to use.
                                        Mutually exclusive with expression.
                                      type: string
                                    expression:
                                      description: |-
                                        expression represents the expression which will be evaluated by CEL.

                                        CEL expressions have access to the contents of the token claims, organized into CEL variable:
                                        - 'claims' is a map of claim names to claim values.
                                          For example, a variable named 'sub' can be accessed as 'claims.sub'.
                                          Nested claims can be accessed using dot notation, e.g. 'claims.foo.bar'.

                                        Documentation on CEL: https://kubernetes.io/docs/reference/using-api/cel/

                                        Mutually exclusive with claim and prefix.
                                      type: string
                                    prefix:
                                      description: |-
                                        prefix is prepended to claim's value to prevent clashes with existing names.
                                        prefix needs to be set if claim is set and can be the empty string.
                                        Mutually exclusive with expression.
                                      type: string
                                  type: object
                              required:
                              - username
                              type: object
                            claimValidationRules:
                              description: claimValidationRules are rules that are
                                applied to validate token claims to authenticate users.
                              items:
                                description: ClaimValidationRule provides the configuration
                                  for a single claim validation rule.
                                properties:
                                  claim:
                                    description: |-
                                      claim is the name of a required claim.
                                      Same as --oidc-required-claim flag.
                                      Only string claim keys are supported.
                                      Mutually exclusive with expression and message.
                                    type: string
                                  expression:
                                    description: |-
                                      expression represents the expression which will be evaluated by CEL.
                                      Must produce a boolean.

                                      CEL expressions have access to the contents of the token claims, organized into CEL variable:
                                      - 'claims' is a map of claim names to claim values.
                                        For example, a variable named 'sub' can be accessed as 'claims.sub'.
                                        Nested claims can be accessed using dot notation, e.g. 'claims.foo.bar'.
                                      Must return true for the validation to pass.

                                      Documentation on CEL: https://kubernetes.io/docs/reference/using-api/cel/

                                      Mutually exclusive with claim and requiredValue.
                                    type: string
                                  message:
                                    description: |-
                                      message customizes the returned error message when expression returns false.
                                      message is a literal string.
                                      Mutually exclusive with claim and requiredValue.
                                    type: string
                                  requiredValue:
                                    description: |-
                                      requiredValue is the value of a required claim.
                                      Same as --oidc-required-claim flag.
                                      Only string claim values are supported.
                                      If claim is set and requiredValue is not set, the claim must be present with a value set to the empty string.
                                      Mutually exclusive with expression and message.
                                    type: string
                                type: object
                              type: array
                            issuer:
                              description: issuer contains the basic OIDC provider
                                connection options.
                              properties:
                                audienceMatchPolicy:
                                  description: |-
                                    audienceMatchPolicy defines how the "audiences" field is used to match the "aud" claim in the presented JWT.
                                    Allowed values are:
                                    1. "MatchAny" when multiple audiences are specified and
                                    2. empty (or unset) or "MatchAny" when a single audience is specified.

                                    - MatchAny: the "aud" claim in the presented JWT must match at least one of the entries in the "audiences" field.
                                    For example, if "audiences" is ["foo", "bar"], the "aud" claim in the presented JWT must contain either "foo" or "bar" (and may contain both).

                                    - "": The match policy can be empty (or unset) when a single audience is specified in the "audiences" field. The "aud" claim in the presented JWT must contain the single audience (and may contain others).

                                    For more nuanced audience validation, use claimValidationRules.
                                      example: claimValidationRule[].expression: 'sets.equivalent(claims.aud, ["bar", "foo", "baz"])' to require an exact match.
                                  type: string
                                audiences:
                                  description: |-
                                    audiences is the set of acceptable audiences the JWT must be issued to.
                                    At least one of the entries must match the "aud" claim in presented JWTs.
                                    Same value as the --oidc-client-id flag (though this field supports an array).
                                    Required to be non-empty.
                                  items:
                                    type: string
                                  type: array
                                certificateAuthority:
                                  description: |-
                                    certificateAuthority contains PEM-encoded certificate authority certificates
                                    used to validate the connection when fetching discovery information.
                                    If unset, the system verifier is used.
                                    Same value as the content of the file referenced by the --oidc-ca-file flag.
                                  type: string
                                discoveryURL:
                                  description: |-
                                    discoveryURL, if specified, overrides the URL used to fetch discovery
                                    information instead of using "{url}/.well-known/openid-configuration".
                                    The exact value specified is used, so "/.well-known/openid-configuration"
                                    must be included in discoveryURL if needed.

                                    The "issuer" field in the fetched discovery information must match the "issuer.url" field
                                    in the AuthenticationConfiguration and will be used to validate the "iss" claim in the presented JWT.
                                    This is for scenarios where the well-known and jwks endpoints are hosted at a different
                                    location than the issuer (such as locally in the cluster).

                                    Example:
                                    A discovery url that is exposed using kubernetes service 'oidc' in namespace 'oidc-namespace'
                                    and discovery information is available at '/.well-known/openid-configuration'.
                                    discoveryURL: "https://oidc.oidc-namespace/.well-known/openid-configuration"
                                    certificateAuthority is used to verify the TLS connection and the hostname on the leaf certificate
                                    must be set to 'oidc.oidc-namespace'.

                                    curl https://oidc.oidc-namespace/.well-known/openid-configuration (.discoveryURL field)
                                    {
                                        issuer: "https://oidc.example.com" (.url field)
                                    }

                                    discoveryURL must be different from url.
                                    Required to be unique across all JWT authenticators.
                                    Note that egress selection configuration is not used for this network connection.
                                  type: string
                                url:
                                  description: |-
                                    url points to the issuer URL in a format https://url or https://url/path.
                                    This must match the "iss" claim in the presented JWT, and the issuer returned from discovery.
                                    Same value as the --oidc-issuer-url flag.
                                    Discovery information is fetched from "{url}/.well-known/openid-configuration" unless overridden by discoveryURL.
                                    Required to be unique across all JWT authenticators.
                                    Note that egress selection configuration is not used for this network connection.
                                  type: string
                              required:
                              - audiences
                              - url
                              type: object
                            userValidationRules:
                              description: |-
                                userValidationRules are rules that are applied to final user before completing authentication.
                                These allow invariants to be applied to incoming identities such as preventing the
                                use of the system: prefix that is commonly used by Kubernetes components.
                                The validation rules are logically ANDed together and must all return true for the validation to pass.
                              items:
                                description: UserValidationRule provides the configuration
                                  for a single user info validation rule.
                                properties:
                                  expression:
                                    description: |-
                                      expression represents the expression which will be evaluated by CEL.
                                      Must return true for the validation to pass.

                                      CEL expressions have access to the contents of UserInfo, organized into CEL variable:
                                      - 'user' - authentication.k8s.io/v1, Kind=UserInfo object
                                         Refer to https://github.com/kubernetes/api/blob/release-1.28/authentication/v1/types.go#L105-L122 for the definition.
                                         API documentation: https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.28/#userinfo-v1-authentication-k8s-io

                                      Documentation on CEL: https://kubernetes.io/docs/reference/using-api/cel/
                                    type: string
                                  message:
                                    description: |-
                                      message customizes the returned error message when rule returns false.
                                      message is a literal string.
                                    type: string
                                required:
                                - expression
                                type: object
                              type: array
                          required:
                          - claimMappings
                          - issuer
                          type: object
                        type: array
                    type: object
                  maxLogStreamDurationMinutes:
                    description: |-
                      MaxLogStreamDurationMinutes is the maximum duration for log streaming in minutes
                      Default: 120 (2 hours)
                    format: int32
                    type: integer
                  maxManifestSize:
                    description: |-
                      MaxManifestSize is the maximum allowed manifest size in bytes
                      Default: 10485760 (10MB)
                    format: int64
                    type: integer
                  maxTotalUploadSize:
                    description: |-
                      MaxTotalUploadSize is the maximum total upload size per request in bytes
                      Default: 2147483648 (2GB)
                    format: int64
                    type: integer
                  maxUploadFileSize:
                    description: |-
                      MaxUploadFileSize is the maximum size for individual uploaded files in bytes
                      Default: 1073741824 (1GB)
                    format: int64
                    type: integer
                type: object
              jumpstarter:
                description: Jumpstarter defines configuration for Jumpstarter device
                  flashing integration
                properties:
                  image:
                    default: quay.io/jumpstarter-dev/jumpstarter:latest
                    description: Image is the container image for Jumpstarter CLI
                      operations
                    type: string
                  namespace:
                    description: Namespace is the OpenShift namespace where Jumpstarter
                      is installed
                    type: string
                  targetMappings:
                    additionalProperties:
                      description: JumpstarterTargetMapping defines the Jumpstarter
                        configuration for a specific build target
                      properties:
                        flashCmd:
                          description: |-
                            FlashCmd is the command template for flashing the device
                            Example: "j storage flash ${IMAGE}"
                          type: string
                        selector:
                          description: |-
                            Selector is the label selector for matching Jumpstarter exporters
                            Example: "board-type=j784s4evm"
                          type: string
                      required:
                      - selector
                      type: object
                    description: TargetMappings maps build targets to Jumpstarter
                      exporter configurations
                    type: object
                type: object
              osBuilds:
                description: OSBuilds defines the configuration for OS build operations
                properties:
                  clusterRegistryRoute:
                    description: |-
                      ClusterRegistryRoute is the external route for the cluster's internal image registry
                      Required for bootc builds to allow nested containers to pull builder images
                      Example: "default-route-openshift-image-registry.apps.mycluster.example.com"
                    type: string
                  enabled:
                    default: true
                    description: Enabled determines if Tekton tasks for OS builds
                      should be deployed
                    type: boolean
                  memoryVolumeSize:
                    description: |-
                      MemoryVolumeSize specifies the size limit for memory-backed volumes
                      Only used when UseMemoryVolumes or UseMemoryContainerStorage is true
                      Example: "2Gi"
                    type: string
                  nodeSelector:
                    additionalProperties:
                      type: string
                    description: |-
                      NodeSelector specifies node labels that build pods must match for scheduling
                      These labels are added to the pod template used by Tekton PipelineRuns
                      Example: {"dedicated": "builds", "disktype": "ssd"}
                    type: object
                  pvcSize:
                    description: |-
                      PVCSize specifies the size for persistent volume claims created for build workspaces
                      Default: "8Gi"
                    type: string
                  runtimeClassName:
                    description: |-
                      RuntimeClassName specifies the runtime class to use for the build pod
                      More info: https://kubernetes.io/docs/concepts/containers/runtime-class/
                    type: string
                  tolerations:
                    description: |-
                      Tolerations specifies tolerations to be added to build pods
                      Enables scheduling on tainted nodes for dedicated/exclusive access
                      Example: [{"key": "automotive.sdv.cloud.redhat.com/dedicated", "operator": "Equal",
                                "value": "builds", "effect": "NoSchedule"}]
                    items:
                      description: |-
                        The pod this Toleration is attached to tolerates any taint that matches
                        the triple <key,value,effect> using the matching operator <operator>.
                      properties:
                        effect:
                          description: |-
                            Effect indicates the taint effect to match. Empty means match all taint effects.
                            When specified, allowed values are NoSchedule, PreferNoSchedule and NoExecute.
                          type: string
                        key:
                          description: |-
                            Key is the taint key that the toleration applies to. Empty means match all taint keys.
                            If the key is empty, operator must be Exists; this combination means to match all values and all keys.
                          type: string
                        operator:
                          description: |-
                            Operator represents a key's relationship to the value.
                            Valid operators are Exists and Equal. Defaults to Equal.
                            Exists is equivalent to wildcard for value, so that a pod can
                            tolerate all taints of a particular category.
                          type: string
                        tolerationSeconds:
                          description: |-
                            TolerationSeconds represents the period of time the toleration (which must be
                            of effect NoExecute, otherwise this field is ignored) tolerates the taint. By default,
                            it is not set, which means tolerate the taint forever (do not evict). Zero and
                            negative values will be treated as 0 (evict immediately) by the system.
                          format: int64
                          type: integer
                        value:
                          description: |-
                            Value is the taint value the toleration matches to.
                            If the operator is Exists, the value should be empty, otherwise just a regular string.
                          type: string
                      type: object
                    type: array
                  useMemoryContainerStorage:
                    description: |-
                      UseMemoryContainerStorage determines whether to use memory-backed volumes for container storage
                      This controls /var/lib/containers/storage, /run/osbuild, and /var/tmp volumes
                      Default: false (disk-backed)
                    type: boolean
                  useMemoryVolumes:
                    description: |-
                      UseMemoryVolumes determines whether to use memory-backed volumes for build operations
                      Default: false (disk-backed)
                    type: boolean
                required:
                - enabled
                type: object
            type: object
          status:
            description: OperatorConfigStatus defines the observed state of OperatorConfig
            properties:
              jumpstarterAvailable:
                description: JumpstarterAvailable indicates if Jumpstarter CRDs are
                  present in the cluster
                type: boolean
              message:
                description: Message provides detail about the current phase
                type: string
              observedGeneration:
                description: ObservedGeneration is the most recent generation observed
                  by the controller.
                format: int64
                type: integer
              osBuildsDeployed:
                description: OSBuildsDeployed indicates if the OS Builds Tekton tasks
                  are currently deployed
                type: boolean
              phase:
                description: Phase represents the current phase (Ready, Reconciling,
                  Failed)
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
status:
  acceptedNames:
    kind: ""
    plural: ""
  conditions: null
  storedVersions: null
